

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>JSDoc: views/home/ChatForm.js</title>

    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="./build/entry.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://fonts.googleapis.com/css?family=Muli:100,400,700|Oswald:300|Inconsolata,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
    <link type="text/css" rel="stylesheet" href="styles/app.min.css">
    <link type="text/css" rel="stylesheet" href="styles/iframe.css">
</head>

<body>
    <div id="stickyNavbarOverlay"></div>
    <div class="top-navbar">
        <div class="container">
            <nav class="navbar" role="navigation" aria-label="main navigation">
                <div class="navbar-brand">
                    
                    
                        <h1 class="navbar-item">Documentation</h1>
                    
                    <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                
            </nav>
        </div>
    </div>
    <div class="container">
        <div class="columns">
            <div class="column is-3" id="sidebarNav">
                <div class="sidebar">
                    <nav>
                        <h2><a href="index.html">Home</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AplicationAction.html">AplicationAction</a></li><li><a href="module-ChatAction.html">ChatAction</a></li><li><a href="module-ConfigurationAction.html">ConfigurationAction</a></li><li><a href="module-ContactAction.html">ContactAction</a></li><li><a href="module-navigationService.html">navigationService</a></li><li><a href="module-Utils.html">Utils</a></li></ul><h3>Classes</h3><ul><li><a href="AddContact.html">AddContact</a></li><li><a href="Bitcoin.html">Bitcoin</a></li><li><a href="Chat.html">Chat</a></li><li><a href="ChatBody.html">ChatBody</a></li><li><a href="ChatForm.html">ChatForm</a></li><li><a href="Config.html">Config</a></li><li><a href="Contacts.html">Contacts</a></li><li><a href="DualComponent.html">DualComponent</a></li><li><a href="EditName.html">EditName</a></li><li><a href="EditPhoto.html">EditPhoto</a></li><li><a href="FloatButtons.html">FloatButtons</a></li><li><a href="HeaderComponent.html">HeaderComponent</a></li><li><a href="index_.html">index</a></li><li><a href="InitialStep.html">InitialStep</a></li><li><a href="MenuComponent.html">MenuComponent</a></li><li><a href="NotifService.html">NotifService</a></li><li><a href="Socket.html">Socket</a></li></ul><h3>Global</h3><ul><li><a href="global.html#componentName">componentName</a></li></ul></div>
                    </nav>
                </div>
            </div>
            <div class="column is-9-desktop">
                <div class="content" id="main-content-wrapper">
                    <header class="page-title">
                        <p>Source</p>
                        <h1>views/home/ChatForm.js</h1>
                    </header>
                    
                    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { Component } from "react";
import { Icon, Button } from "native-base";
import {
  View,
  StyleSheet,
  TextInput,
  ScrollView,
  TouchableOpacity,
  Platform,
  Text
} from "react-native";
import RNFS from "react-native-fs";
import { FileDirectory } from "../../utils/utils";
import { sha256 } from "js-sha256";
import { AudioRecorder, AudioUtils } from "react-native-audio";
import * as Animatable from "react-native-animatable";
import moment from "moment";

/**
 *
 *
 * @export
 * @class ChatForm
 * @description component where is the form to write the message send notes from you and files
 * @extends {Component}
 */
export default class ChatForm extends Component {
  constructor(props) {
    super(props);
    this.state = {
      message: "",
      height: 20,
      currentTime: 0.0,
      recording: false,
      paused: false,
      stoppedRecording: false,
      finished: false,
      audioPath:
        AudioUtils.DocumentDirectoryPath + `/AUDIO_${new Date().getTime()}.aac`,
      hasPermission: undefined
    };
  }

  handleViewRef = ref => (this.view = ref);

  componentDidMount = () => {
    const { user, navigation, setChat, previousChat } = this.props;
    const toUID = navigation.params ? navigation.params.hashUID : null;
    AudioRecorder.requestAuthorization().then(isAuthorised => {
      this.setState({ hasPermission: isAuthorised });

      if (!isAuthorised) return;

      this.prepareRecordingPath(this.state.audioPath);

      AudioRecorder.onProgress = data => {
        this.setState({ currentTime: Math.floor(data.currentTime) });
      };

      AudioRecorder.onFinished = data => {
        const newPath = `${FileDirectory}/Audios/AUDIO_${new Date().getTime()}.aac`;
        RNFS.exists(this.state.audioPath).then(() => {
          RNFS.moveFile(this.state.audioPath, newPath).then(() => {
            const sendObject = {
              fromUID: sha256(user.uid),
              toUID: toUID,
              msg: {
                text: "",
                typeFile: "audio"
              },
              timestamp: new Date().getTime(),
              type: "msg"
            };

            const id = sha256(
              `${sha256(user.uid)} + ${toUID}  +  ${
                sendObject.msg.text
              }  + ${new Date().getTime()}`
            );

            this.props.sendMessagesWithSound(
              { ...sendObject, msgID: id },
              newPath,
              data.base64
            );
          });
        });
      };
    });
  };

  prepareRecordingPath = audioPath => {
    AudioRecorder.prepareRecordingAtPath(audioPath, {
      SampleRate: 22050,
      Channels: 1,
      AudioQuality: "Low",
      AudioEncoding: "aac",
      AudioEncodingBitRate: 32000,
      IncludeBase64: true
    });
  };

  _record = async () => {
    this.setState({ recording: true });
    if (this.state.recording) {
      console.warn("Already recording!");
      return;
    }
    if (!this.state.hasPermission) {
      console.warn("Can't record, no permission granted!");
      return;
    }
    if (this.state.stoppedRecording) {
      this.prepareRecordingPath(this.state.audioPath);
    }
    this.setState({ recording: true, paused: false });
    try {
      const filePath = await AudioRecorder.startRecording();
    } catch (error) {
      console.error(error);
    }
  };

  _stop = async () => {
    // this.setState({ recording: false });
    if (!this.state.recording) {
      console.warn("Can't stop, not recording!");
      return;
    }
    this.setState({ stoppedRecording: true, recording: false, paused: false });
    try {
      const filePath = await AudioRecorder.stopRecording();
      if (Platform.OS === "android") {
        this._finishRecording(true, filePath);
      }
      return filePath;
    } catch (error) {
      console.error(error);
    }
  };

  _finishRecording(didSucceed, filePath, fileSize) {
    this.setState({ finished: didSucceed });
  }

  send = () => {
    const { user, navigation, setChat, previousChat } = this.props;
    const toUID = navigation.params ? navigation.params.hashUID : null;
    const sendObject = {
      fromUID: sha256(user.uid),
      toUID: toUID,
      msg: {
        text: this.state.message
      },
      timestamp: new Date().getTime(),
      type: "msg"
    };

    const id = sha256(
      `${sha256(user.uid)} + ${toUID}  +  ${
        sendObject.msg.text
      }  + ${new Date().getTime()}`
    );

    setChat({ ...sendObject, msgID: id });
    this.setState({ message: "" });
  };

  render() {
    return (
      &lt;View
        style={{ minHeight: 50, height: this.state.height, maxHeight: 120 }}
      >
        &lt;ScrollView
          contentContainerStyle={styles.contentForm}
          keyboardShouldPersistTaps={"handled"}
        >
          {!this.state.recording &amp;&amp; (
            &lt;>
              &lt;TouchableOpacity onPress={() => this.props.openFileModal()}>
                &lt;Icon
                  style={styles.iconChatStyle}
                  type="MaterialIcons"
                  name="attach-file"
                />
              &lt;/TouchableOpacity>
              &lt;TextInput
                multiline={true}
                style={{ height: this.state.height }}
                value={this.state.message}
                onChangeText={text => this.setState({ message: text })}
                onContentSizeChange={event => {
                  this.setState({
                    height: event.nativeEvent.contentSize.height
                  });
                }}
                placeholder="Mensaje"
                style={{
                  flex: 1
                }}
              />
            &lt;/>
          )}
          &lt;View style={{ flexDirection: "row" }}>
            {this.state.recording &amp;&amp; (
              &lt;View
                style={{
                  flex: 1,
                  justifyContent: "center",
                  alignItems: "center"
                }}
              >
                &lt;Animatable.View animation="slideInRight" duration={1000}>
                  &lt;View
                    style={{
                      flexDirection: "row",
                      minWidth: "70%"
                    }}
                  >
                    &lt;Icon
                      name="trash"
                      style={{ fontSize: 25, color: "#9e9e9e" }}
                    />
                    &lt;Text style={{ fontSize: 20, marginLeft: 10 }}>
                      {moment
                        .utc(this.state.currentTime * 1000)
                        .format("mm:ss")}
                    &lt;/Text>
                    &lt;View
                      style={{
                        marginHorizontal: 10,
                        flexDirection: "row",
                        justifyContent: "center",
                        alignItems: "center"
                      }}
                    >
                      &lt;Icon
                        name="arrow-dropleft"
                        style={{ marginHorizontal: 10, color: "#9e9e9e" }}
                      />
                      &lt;Text>Desliza para Cancelar&lt;/Text>
                    &lt;/View>
                  &lt;/View>
                &lt;/Animatable.View>
              &lt;/View>
            )}

            {this.state.message.length === 0 &amp;&amp; (
              &lt;TouchableOpacity
                activeOpacity={1}
                onPressIn={() => this._record()}
                onPressOut={() => this._stop()}
              >
                &lt;Icon
                  style={
                    this.state.recording
                      ? styles.buttonTouch
                      : styles.iconChatStyle
                  }
                  type="MaterialIcons"
                  name="mic"
                />
              &lt;/TouchableOpacity>
            )}
          &lt;/View>
          {this.state.message.length !== 0 &amp;&amp; (
            &lt;TouchableOpacity onPress={this.send}>
              &lt;Icon
                style={styles.iconChatStyle}
                type="MaterialIcons"
                name="send"
              />
            &lt;/TouchableOpacity>
          )}
        &lt;/ScrollView>
      &lt;/View>
    );
  }
}

const styles = StyleSheet.create({
  container: {
    minHeight: 50
  },

  iconChatStyle: {
    color: "#fbc233",
    fontSize: 32,
    paddingHorizontal: 5,
    paddingBottom: 7
  },
  contentForm: {
    flexDirection: "row",
    alignItems: "flex-end",
    flex: 1,
    justifyContent: "space-between"
  },
  buttonTouch: {
    color: "green",
    fontSize: 40,
    paddingHorizontal: 5,
    paddingBottom: 7
  }
});
</code></pre>
        </article>
    </section>




                </div>
            </div>
        </div>
    </div>

<footer class="footer">
    <div class="content has-text-centered">
        <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Fri Oct 25 2019 14:50:01 GMT-0400 (GMT-04:00)</p>
        <p class="sidebar-created-by">
            <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
            <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
        </p>
    </div>
</footer>

<script src="scripts/app.min.js"></script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
